#!/usr/bin/env sos-runner
#fileformat=SOS1.0

# This script releases notebooks and pipelines:
#
# 1. website to github.io

[convert_documentation]
input:  '*.ipynb', group_by=1
output: os.path.join('../website', _input[0].replace('.ipynb', '.html'))

run:
	jupyter nbconvert --to html --output ${_output!a} ${_input!a} --template toc2

[convert_pipeline]
input:  '*.sos', group_by=1
output: os.path.join('../website', _input[0].replace('.sos', '.html'))

run:
	sos convert ${_input} ${_output} --raw ${_input!b}

[publish]

# prepare
run: workdir='..'
	git checkout master
	# remove gh-pages branch if exists
	if [ "`git branch --list gh-pages`" ]; then
		git branch -D gh-pages
	fi

# convert ipynb to HTML
sos_run('convert_documentation')
sos_run('convert_pipeline')

# push subtree to gh-pages
run: workdir='..'
	git add --all website/*
	git commit . --no-verify -m 'Publish website'
	git push --no-verify
	git subtree split --prefix website -b gh-pages
	git push --no-verify -f origin gh-pages:gh-pages
	git branch -D gh-pages

[default]
sos_run('publish')