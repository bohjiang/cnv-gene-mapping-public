<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<title>simulation_simplify</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>








<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>

 <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

<style>  /* defined here in case the main.css below cannot be loaded */
.lev1 {margin-left: 80px}
.lev2 {margin-left: 100px}
.lev3 {margin-left: 120px}
.lev4 {margin-left: 140px}
.lev5 {margin-left: 160px}
.lev6 {margin-left: 180px}
</style>

<link rel="stylesheet" type="text/css" href="../../css/jt.css">
<link rel="stylesheet" type="text/css" href="../../css/toc2.css">

<script src="../../js/toc2.js"></script>
<script src="../../js/docs.js"></script>

<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["STIX","TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>

<script>
$( document ).ready(function(){

            var cfg={'threshold':3,     // depth of toc (number of levels)
             'number_sections': false, 
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }

            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;

            // fire the main function with these parameters


            table_of_contents(cfg,st);

            var file=analysisDict[$("h1:first").attr("id")];
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            var docs=documentation;
            var pos=documentation.indexOf(file);
        
            for (var a=pos;a>=0;a--){
                  var name=docs[a]
                  $('<li><a href="'+name+'.html">'+name.replace(/_/g," ")+'</a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+file+'.html'+'"]').css("color","#126dce");


            $('<li id="indexHome"><a href="../../documentation.html"><b>Analysis Home<b></a></li>').insertBefore("#toc-level0 li:eq(0)");
            for (var a=pos+1;a<docs.length;a++){
                  var name=docs[a]
                  $(".toc #toc-level0").append('<li><a href="'+name+'.html">'+name.replace(/_/g," ")+'</a></li>');
            }
            $("#toc-header").hide();

    });
</script>
<body>
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandasql</span> <span class="k">import</span> <span class="n">sqldf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">scipy.special</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="k">import</span> <span class="n">logsumexp</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="k">import</span> <span class="n">GaussianMixture</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">fisher</span> <span class="k">import</span> <span class="n">pvalue</span>

<span class="o">%</span><span class="k">matplotlib</span> inline


<span class="k">def</span> <span class="nf">load_reference_gene</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Load reference gene database&#39;&#39;&#39;</span>
    <span class="n">ref_gene</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> 
                         <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> 
                         <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tx_name&quot;</span><span class="p">,</span> <span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_start&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_end&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_name&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ref_gene</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_start&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_end&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">load_cnv_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;load cnv data&#39;&#39;&#39;</span>
    <span class="n">cnvbed</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;name=&quot;</span><span class="p">)</span>
            <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">]:</span>
            <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">cnvbed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">]:</span>
            <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">chrom</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">cnvbed_df</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">cnvbed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cnvbed_df</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;chrom&quot;</span><span class="p">:[],</span> <span class="s2">&quot;cnv_start&quot;</span><span class="p">:[],</span> <span class="s2">&quot;cnv_end&quot;</span><span class="p">:[]}</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">]:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cnvbed</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">chrom</span><span class="p">]))</span> 
            <span class="n">cnvbed_df</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;chrom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">chrom</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
            <span class="n">cnvbed_df</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;cnv_start&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">cnvbed_df</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;cnv_end&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="n">cnvbed_df</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cnvbed_df</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
                                                <span class="n">subset</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;cnv_start&quot;</span><span class="p">,</span> <span class="s2">&quot;cnv_end&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cnvbed_df</span>

<span class="k">def</span> <span class="nf">count_cnv_by_block</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">block_size</span><span class="p">):</span>
    <span class="c1"># check how many CNVs start in block_size = 100K blocks genome</span>
    <span class="c1"># this cell produces `block_counts`: ((chrom, block_position), count)</span>
    <span class="k">def</span> <span class="nf">count_by_blocks</span><span class="p">(</span><span class="n">chrom</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;chrom == &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="p">))[</span><span class="s1">&#39;cnv_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">counts</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end_pos</span> <span class="o">-</span> <span class="n">start_pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">block_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
                                <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">counts</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">]</span>    
    <span class="c1">#</span>
    <span class="n">block_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;chrom&#39;</span><span class="p">]):</span>
        <span class="n">counts</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">count_by_blocks</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span>
        <span class="n">block_counts</span><span class="o">.</span><span class="n">extend</span><span class="p">([((</span><span class="n">chrom</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">counts</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">block_counts</span>

<span class="k">def</span> <span class="nf">fit_truncated_gaussian_mix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="o">-</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">covariance_type</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clf</span>

<span class="k">def</span> <span class="nf">sample_cnv_length</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mean_num_cnv</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">mean_num_cnv</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sample_blocks</span><span class="p">(</span><span class="n">block_counts</span><span class="p">,</span> <span class="n">num_cnv</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;sample blocks from blocks across genome&#39;&#39;&#39;</span>
    <span class="n">probability_distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">block_counts</span><span class="p">])</span>
    <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block_counts</span><span class="p">)),</span> <span class="n">num_cnv</span><span class="p">,</span> 
                                  <span class="n">p</span> <span class="o">=</span> <span class="n">probability_distribution</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probability_distribution</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">block_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sample_idx</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">assign_cnv_to_sample</span><span class="p">(</span><span class="n">sample_blocks</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="n">block_size</span><span class="p">):</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chrom&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;cnv_start&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;cnv_terminate&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_blocks</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">):</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">)</span>
        <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;cnv_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span>
        <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;cnv_terminate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_pos</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;chrom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">annotate_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT cnv.chrom, cnv.cnv_start, cnv.cnv_terminate, gene.tx_name, gene.gene_name</span>
<span class="s2">        FROM samples cnv LEFT JOIN gene_df gene</span>
<span class="s2">        WHERE cnv.chrom == gene.chrom </span>
<span class="s2">        AND (</span>
<span class="s2">        (cnv.cnv_start &gt;= gene.tx_start AND cnv.cnv_start &lt;= gene.tx_end)</span>
<span class="s2">        OR</span>
<span class="s2">        (cnv.cnv_terminate &gt;= gene.tx_start AND cnv.cnv_terminate &lt;= gene.tx_end)</span>
<span class="s2">        OR</span>
<span class="s2">        (cnv.cnv_start &lt;= gene.tx_start AND cnv.cnv_terminate &gt;= gene.tx_end)</span>
<span class="s2">        )</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># drop_duplicates(): make sure the case that CNV spread multiple txs but one gene to be counted only once</span>
    <span class="k">return</span> <span class="n">sqldf</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;cnv_start&quot;</span><span class="p">,</span> <span class="s2">&quot;cnv_terminate&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_name&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_causal_genes</span><span class="p">(</span><span class="n">causal_genes</span><span class="p">,</span> <span class="n">sample_genes</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;get causal genes&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">causal_genes</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sample_genes</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_ccnv</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;get causal cnvs&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="kc">None</span>
    
<span class="k">def</span> <span class="nf">p_case</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">num_causal_genes_in_sample</span><span class="p">,</span> <span class="n">sim_args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num_causal_genes_in_sample</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="n">baseline_odds</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">odds_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">sim_args</span><span class="p">[</span><span class="s2">&quot;odds_ratio_params&quot;</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span> 
                                          <span class="n">sim_args</span><span class="p">[</span><span class="s2">&quot;odds_ratio_params&quot;</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">])</span> 
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_causal_genes_in_sample</span><span class="p">)])</span>
    <span class="n">odds</span> <span class="o">=</span> <span class="n">baseline_odds</span> <span class="o">*</span> <span class="n">odds_ratio</span>
    <span class="k">return</span> <span class="n">odds</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">odds</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Environment</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;block_size&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
                     <span class="s1">&#39;avg_cnv_per_individual&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                     <span class="s1">&#39;n_case&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s1">&#39;n_ctrl&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="c1"># set Gamma shape to be 3 instead of 5</span>
                     <span class="s1">&#39;odds_ratio_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                     <span class="s1">&#39;prevalence&#39;</span><span class="p">:</span> <span class="mf">0.005</span>
                    <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">causal_genes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;causal_genes_del&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;RAB2B&#39;</span><span class="p">,</span> <span class="s1">&#39;CHD8&#39;</span><span class="p">,</span> <span class="s1">&#39;TOX4&#39;</span><span class="p">,</span> <span class="s1">&#39;SNORD8&#39;</span><span class="p">,</span> <span class="s1">&#39;METTL3&#39;</span><span class="p">,</span> <span class="s1">&#39;SALL2&#39;</span><span class="p">,</span> <span class="s1">&#39;SNORD9&#39;</span><span class="p">,</span> <span class="s1">&#39;SUPT16H&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;RPGRIP1&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR3180-3&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR3670-1&#39;</span><span class="p">,</span> <span class="s1">&#39;NOMO2&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR6511A4&#39;</span><span class="p">,</span> <span class="s1">&#39;NPIPA8&#39;</span><span class="p">,</span> <span class="s1">&#39;FSIP2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;FSIP2-AS1&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC101927196&#39;</span><span class="p">,</span> <span class="s1">&#39;ATP6V1E1&#39;</span><span class="p">,</span> <span class="s1">&#39;BCL2L13&#39;</span><span class="p">,</span> <span class="s1">&#39;BID&#39;</span><span class="p">,</span> <span class="s1">&#39;CECR1&#39;</span><span class="p">,</span> <span class="s1">&#39;CECR2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;CECR3&#39;</span><span class="p">,</span> <span class="s1">&#39;CECR5&#39;</span><span class="p">,</span> <span class="s1">&#39;CECR5-AS1&#39;</span><span class="p">,</span> <span class="s1">&#39;CECR6&#39;</span><span class="p">,</span> <span class="s1">&#39;CECR7&#39;</span><span class="p">,</span> <span class="s1">&#39;FLJ41941&#39;</span><span class="p">,</span> <span class="s1">&#39;GAB4&#39;</span><span class="p">,</span> <span class="s1">&#39;IL17RA&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;LINC00528&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC100996342&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC100996415&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC101929372&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC105379550&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;MICAL3&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR3198-1&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR648&#39;</span><span class="p">,</span> <span class="s1">&#39;PEX26&#39;</span><span class="p">,</span> <span class="s1">&#39;SLC25A18&#39;</span><span class="p">,</span> <span class="s1">&#39;TUBA8&#39;</span><span class="p">,</span> <span class="s1">&#39;USP18&#39;</span><span class="p">,</span> <span class="s1">&#39;FAM72C&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;FAM72D&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC01138&#39;</span><span class="p">,</span> <span class="s1">&#39;NBPF8&#39;</span><span class="p">,</span> <span class="s1">&#39;PPIAL4G&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR6770-2&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR3179-1&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR3180-2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;MACROD2&#39;</span><span class="p">,</span> <span class="s1">&#39;FAM189A1&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC100130111&#39;</span><span class="p">,</span> <span class="s1">&#39;MACROD2-AS1&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC00623&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC00869&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;PPIAL4C&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR3680-2&#39;</span><span class="p">,</span> <span class="s1">&#39;ABCC6P1&#39;</span><span class="p">,</span> <span class="s1">&#39;HNRNPC&#39;</span><span class="p">,</span> <span class="s1">&#39;APBA2&#39;</span><span class="p">,</span> <span class="s1">&#39;C22orf39&#39;</span><span class="p">,</span> <span class="s1">&#39;CDC45&#39;</span><span class="p">,</span> <span class="s1">&#39;CLDN5&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;CLTCL1&#39;</span><span class="p">,</span> <span class="s1">&#39;DGCR14&#39;</span><span class="p">,</span> <span class="s1">&#39;DGCR2&#39;</span><span class="p">,</span> <span class="s1">&#39;GNB1L&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLGA6L7P&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLGA8M&#39;</span><span class="p">,</span> <span class="s1">&#39;GP1BB&#39;</span><span class="p">,</span> <span class="s1">&#39;GSC2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;HIRA&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC00895&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC01311&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC100289656&#39;</span><span class="p">,</span> <span class="s1">&#39;MRPL40&#39;</span><span class="p">,</span> <span class="s1">&#39;NPIPB4&#39;</span><span class="p">,</span> <span class="s1">&#39;NSMCE3&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;PDCD6IPP2&#39;</span><span class="p">,</span> <span class="s1">&#39;SEPT5&#39;</span><span class="p">,</span> <span class="s1">&#39;SEPT5-GP1BB&#39;</span><span class="p">,</span> <span class="s1">&#39;SLC25A1&#39;</span><span class="p">,</span> <span class="s1">&#39;TBX1&#39;</span><span class="p">,</span> <span class="s1">&#39;TSSK2&#39;</span><span class="p">,</span> <span class="s1">&#39;UFD1L&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;WHAMMP2&#39;</span><span class="p">,</span> <span class="s1">&#39;HSFY1P1&#39;</span><span class="p">,</span> <span class="s1">&#39;PFN1P2&#39;</span><span class="p">,</span> <span class="s1">&#39;XKR3&#39;</span><span class="p">,</span> <span class="s1">&#39;OR4A47&#39;</span><span class="p">,</span> <span class="s1">&#39;C5orf17&#39;</span><span class="p">,</span> <span class="s1">&#39;CNTN4&#39;</span><span class="p">,</span> <span class="s1">&#39;EXOC4&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;LINC00540&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC101927967&#39;</span><span class="p">,</span> <span class="s1">&#39;LRRC4C&#39;</span><span class="p">,</span> <span class="s1">&#39;SMG1P2&#39;</span><span class="p">,</span> <span class="s1">&#39;SPRY2&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC100288162&#39;</span><span class="p">],</span>
            <span class="s2">&quot;causal_genes_dup&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CHN2&#39;</span><span class="p">,</span> <span class="s1">&#39;ESYT2&#39;</span><span class="p">,</span> <span class="s1">&#39;KIF26B&#39;</span><span class="p">,</span> <span class="s1">&#39;RPGRIP1&#39;</span><span class="p">,</span> <span class="s1">&#39;C22orf39&#39;</span><span class="p">,</span> <span class="s1">&#39;CDAN1&#39;</span><span class="p">,</span> <span class="s1">&#39;CDC45&#39;</span><span class="p">,</span> <span class="s1">&#39;CLDN5&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;GNB1L&#39;</span><span class="p">,</span> <span class="s1">&#39;GP1BB&#39;</span><span class="p">,</span> <span class="s1">&#39;HIRA&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC00895&#39;</span><span class="p">,</span> <span class="s1">&#39;MRPL40&#39;</span><span class="p">,</span> <span class="s1">&#39;SEPT5&#39;</span><span class="p">,</span> <span class="s1">&#39;SEPT5-GP1BB&#39;</span><span class="p">,</span> <span class="s1">&#39;STARD9&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;TBX1&#39;</span><span class="p">,</span> <span class="s1">&#39;TTBK2&#39;</span><span class="p">,</span> <span class="s1">&#39;UFD1L&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC283177&#39;</span><span class="p">,</span> <span class="s1">&#39;AGAP6&#39;</span><span class="p">,</span> <span class="s1">&#39;COL18A1&#39;</span><span class="p">,</span> <span class="s1">&#39;COL18A1-AS1&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;FAM21EP&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC440910&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR6815&#39;</span><span class="p">,</span> <span class="s1">&#39;POTEE&#39;</span><span class="p">,</span> <span class="s1">&#39;SLC19A1&#39;</span><span class="p">,</span> <span class="s1">&#39;TIMM23B&#39;</span><span class="p">,</span> <span class="s1">&#39;VAV2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;WASHC2A&#39;</span><span class="p">,</span> <span class="s1">&#39;PTPRN2&#39;</span><span class="p">,</span> <span class="s1">&#39;ANO2&#39;</span><span class="p">,</span> <span class="s1">&#39;CCNDBP1&#39;</span><span class="p">,</span> <span class="s1">&#39;COLEC12&#39;</span><span class="p">,</span> <span class="s1">&#39;EPB42&#39;</span><span class="p">,</span> <span class="s1">&#39;FAM118A&#39;</span><span class="p">,</span> <span class="s1">&#39;FAM160A1&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;FBLN1&#39;</span><span class="p">,</span> <span class="s1">&#39;KIAA0930&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC01589&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC100996325&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC728613&#39;</span><span class="p">,</span> <span class="s1">&#39;LRRIQ3&#39;</span><span class="p">,</span> <span class="s1">&#39;MACROD2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;MIR1249&#39;</span><span class="p">,</span> <span class="s1">&#39;NUP153&#39;</span><span class="p">,</span> <span class="s1">&#39;NUP50&#39;</span><span class="p">,</span> <span class="s1">&#39;NUP50-AS1&#39;</span><span class="p">,</span> <span class="s1">&#39;PRSS48&#39;</span><span class="p">,</span> <span class="s1">&#39;RAP1GAP2&#39;</span><span class="p">,</span> <span class="s1">&#39;RBM47&#39;</span><span class="p">,</span> <span class="s1">&#39;RIBC2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;SH3D19&#39;</span><span class="p">,</span> <span class="s1">&#39;SMC1B&#39;</span><span class="p">,</span> <span class="s1">&#39;TGM5&#39;</span><span class="p">,</span> <span class="s1">&#39;TMEM62&#39;</span><span class="p">,</span> <span class="s1">&#39;UPK3A&#39;</span><span class="p">,</span> <span class="s1">&#39;VWF&#39;</span><span class="p">,</span> <span class="s1">&#39;DGKH&#39;</span><span class="p">,</span> <span class="s1">&#39;KIF13A&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC01266&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;VWA8&#39;</span><span class="p">,</span> <span class="s1">&#39;VWA8-AS1&#39;</span><span class="p">,</span> <span class="s1">&#39;CRYM-AS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNX29P1&#39;</span><span class="p">,</span> <span class="s1">&#39;KCNJ12&#39;</span><span class="p">,</span> <span class="s1">&#39;KCNJ18&#39;</span><span class="p">,</span> <span class="s1">&#39;BNC1&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;LOC105375545&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR128-2&#39;</span><span class="p">,</span> <span class="s1">&#39;AGAP7P&#39;</span><span class="p">,</span> <span class="s1">&#39;BTBD11&#39;</span><span class="p">,</span> <span class="s1">&#39;C3orf67&#39;</span><span class="p">,</span> <span class="s1">&#39;CHD8&#39;</span><span class="p">,</span> <span class="s1">&#39;COL18A1-AS2&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;FAM110C&#39;</span><span class="p">,</span> <span class="s1">&#39;GMDS&#39;</span><span class="p">,</span> <span class="s1">&#39;HIRIP3&#39;</span><span class="p">,</span> <span class="s1">&#39;INO80E&#39;</span><span class="p">,</span> <span class="s1">&#39;LINC01022&#39;</span><span class="p">,</span> <span class="s1">&#39;MARK3&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR5707&#39;</span><span class="p">,</span> <span class="s1">&#39;MSMB&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;NCAPG2&#39;</span><span class="p">,</span> <span class="s1">&#39;NCOA4&#39;</span><span class="p">,</span> <span class="s1">&#39;PAK5&#39;</span><span class="p">,</span> <span class="s1">&#39;PLEKHB2&#39;</span><span class="p">,</span> <span class="s1">&#39;PWP1&#39;</span><span class="p">,</span> <span class="s1">&#39;RAB2B&#39;</span><span class="p">,</span> <span class="s1">&#39;RNF103-CHMP3&#39;</span><span class="p">,</span> <span class="s1">&#39;SNORD8&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;SNORD9&#39;</span><span class="p">,</span> <span class="s1">&#39;SUPT16H&#39;</span><span class="p">,</span> <span class="s1">&#39;TIMM23&#39;</span><span class="p">,</span> <span class="s1">&#39;ZCCHC14&#39;</span><span class="p">,</span> <span class="s1">&#39;C17orf51&#39;</span><span class="p">,</span> <span class="s1">&#39;COX20&#39;</span><span class="p">,</span> <span class="s1">&#39;DLG1&#39;</span><span class="p">,</span> <span class="s1">&#39;EFCAB2&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_not_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_not_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of causal deletion genes </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">causal_genes</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_new_one</span> <span class="o">=</span> <span class="s1">&#39;hello&#39;</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
        
<span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">refgene</span><span class="p">,</span> <span class="n">cnv_data</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">causal_genes</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cnv_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;cnv_start&quot;</span><span class="p">,</span> <span class="s2">&quot;cnv_end&quot;</span><span class="p">))</span>
    <span class="n">block_counts</span> <span class="o">=</span> <span class="n">count_cnv_by_block</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">])</span>
    <span class="n">cnv_length</span> <span class="o">=</span> <span class="n">cnv_data</span><span class="p">[</span><span class="s1">&#39;cnv_end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cnv_data</span><span class="p">[</span><span class="s1">&#39;cnv_start&#39;</span><span class="p">]</span>
    <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">case_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ctrl_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;niter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span> <span class="kc">None</span><span class="p">]}</span>
    
    <span class="k">while</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="n">sample_len</span> <span class="o">=</span> <span class="n">sample_cnv_length</span><span class="p">(</span><span class="n">cnv_length</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;avg_cnv_per_individual&#39;</span><span class="p">])</span>
        <span class="n">sample_blocks</span> <span class="o">=</span> <span class="n">get_sample_blocks</span><span class="p">(</span><span class="n">block_counts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_len</span><span class="p">))</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">assign_cnv_to_sample</span><span class="p">(</span><span class="n">sample_blocks</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">])</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">annotate_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">refgene</span><span class="p">)</span>
        <span class="n">causal_genes_in_sample</span> <span class="o">=</span> <span class="n">get_causal_genes</span><span class="p">(</span><span class="n">causal_genes</span><span class="p">,</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p_case</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;prevalence&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">causal_genes_in_sample</span><span class="p">),</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1">#debug[&#39;p&#39;].append(p)</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">case_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;n_case&#39;</span><span class="p">]:</span>
            <span class="c1"># sample data is a case</span>
            <span class="n">case_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
            <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">p</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrl_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;n_ctrl&#39;</span><span class="p">]:</span>
            <span class="n">ctrl_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
            <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">case_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;n_case&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrl_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;n_ctrl&#39;</span><span class="p">]:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;niter&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">debug</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;case&#39;</span><span class="p">:</span> <span class="n">case_data</span><span class="p">,</span> <span class="s1">&#39;ctrl&#39;</span><span class="p">:</span> <span class="n">ctrl_data</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span> jupyter nbconvert --to script simulation_simplify.ipynb
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[NbConvertApp] Converting notebook simulation_simplify.ipynb to script
[NbConvertApp] Writing 10727 bytes to simulation_simplify.py
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

</div>
</div>
</div>

</div>
    </div>
  </div>
</body>
</html>
