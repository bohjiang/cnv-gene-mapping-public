#!/usr/bin/env sos-runner
#fileformat=SOS1.0

parameter: web_url = 'http://gaow.github.io/cnv-gene-mapping'

[getFileNames]
run:
	python docs/js/findnames.py

[convert-documentation]
input:  './analysis/*.ipynb', group_by=1
depends: './analysis/toc_doc.tpl'
output: _input[0].replace('/analysis/', '/docs/doc/documentation/').replace('.ipynb', '.html')

run:	
	cd analysis
	sos convert ${_input!a} ${_output!a} --template toc_doc
  perl -0777 -pi -e 'BEGIN{undef $/;}  s/<style type=\"text\/css\">(.+?)<\/style>//smg' ${_output!a}

[convert-writeup]
input:  './writeup/*.ipynb', group_by=1
depends: './writeup/toc_wrt.tpl'
output: _input[0].replace('/writeup/', '/docs/doc/writeup/').replace('.ipynb', '.html')

run: 
	cd writeup
	sos convert ${_input!a} ${_output!a}  --template toc_wrt
  perl -0777 -pi -e 'BEGIN{undef $/;}  s/<style type=\"text\/css\">(.+?)<\/style>//smg' ${_output!a}

[convert-homepage]
input:  './*.ipynb', group_by=1
depends: './writeup/homepage.tpl'
output: "./docs/${_input!bn}.html"

run: 
	sos convert ${_input!a} ${_output!a} --template writeup/homepage.tpl

[update-website]

# convert ipynb to HTML
sos_run('getFileNames')
sos_run('convert-documentation')
sos_run('convert-writeup')
sos_run('convert-homepage')

# push changes to website
parameter: msg = "Update website"

run: workdir='.'
	git add --all docs/doc/* docs/*.html
	git commit docs/*.html docs/doc/* --no-verify -m '${msg}'
	git push --no-verify

[default]
sos_run('update-website')
